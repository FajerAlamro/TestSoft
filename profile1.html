<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_back" />

    <title>الملف الشخصي</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
        }

        body {
            background-color: #fff;
            direction: rtl;
        }

        /* Navbar styling */
        .navbar-fav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: transparent;
            position: relative;
            width: 100%;
        }

        /* Logo styling */
        .logo-fav img {
            width: 60px;
            height: auto;
        }

        /* Hamburger menu styling */
        .humburger-fav {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            z-index: 1100;
            position: relative;
            width: 30px;
            height: 30px;
            justify-content: center;
            align-items: center;
        }

        .humburger-fav .bar-fav {
            width: 30px;
            height: 4px;
            background-color: #09315D;
            margin: 4px 0;
            border-radius: 2px;
            transition: opacity 0.3s ease;
        }

        /* Hide the bars when menu is active and show "X" */
        .humburger-fav.active .bar-fav {
            display: none;
        }

        .humburger-fav.active::before {
            content: "✖"; /* X icon */
            font-size: 28px;
            color: #09315D;
        }

        .profile-header-background {
            background: url('images/back.png') no-repeat center center;
            background-size: cover;
            height: 10vh;
            border-bottom-left-radius: 100px;
        }

        .profile-settings-icon {
            position: absolute;
            top: 18px;
            right: 15px;
            width: 50px;
            height: 50px;
            cursor: pointer;
        }

        .profile-card {
            max-width: 500px;
            margin: 60px auto; 
            padding: 25px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .profile {
            margin-bottom: 20px; 
        }

        .profile img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #002147;
            object-fit: cover;
        }

        .profile h2 {
            color: #002147;
            margin-top: 10px;
            font-size: 22px;
        }

        .profile-ideas-section {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
            margin: 30px 0;
        }

        .profile-ideas-section h3 {
            color: #002147;
            margin-bottom: 10px;
            text-align: center;
        }

        .profile-ideas-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .profile-idea-box {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            margin-bottom: 15px; 
        }

        .profile-idea-icons {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        .profile-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .profile-icon:hover {
            transform: scale(1.1);
        }

        .profile-idea-img {
            width: 60px;
            height: 60px;
            display: block;
            margin: 10px auto;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #002147;
        }

        .profile-idea-title {
            font-weight: bold;
            font-size: 18px;
            margin: 8px 0;
            color: #002147;
        }

        .profile-idea-field, .profile-idea-date {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .profile-contact-info {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .profile-contact-info h3 {
            color: #002147;
            margin-bottom: 10px;
            text-align: center;
        }

        .profile-contact-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .profile-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-contact-item img {
            width: 24px;
            height: 24px;
        }

        .profile-contact-item span {
            font-size: 16px;
            color: #002147;
        }

        .confirmation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #002147;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 280px;
            display: none;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .confirmation-buttons button {
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #confirm-delete {
            background: #e74c3c;
            color: white;
        }

        #confirm-delete:hover {
            background: #c0392b;
        }

        #cancel-delete {
            background: #3498db;
            color: white;
        }

        #cancel-delete:hover {
            background: #2980b9;
        }

        /* Sidebar menu */
        .menu-overlay-fav {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: right 0.4s ease-in-out;
            z-index: 1000;
        }

        .menu-overlay-fav.active {
            right: 0;
        }

        .menu-overlay-fav a {
            font-size: 24px;
            color: #09315D;
            text-decoration: none;
            padding: 15px;
            transition: color 0.3s;
        }

        .menu-overlay-fav a:hover {
            color: #002147;
        }

        .profile-link {
            text-decoration: none;
            color: #09315D;
        }

        .menu-overlay-fav a:visited,
        .profile-link:visited {
            color: #09315D;
        }

        .profile-link img {
            width: 90px; 
            height: 90px; 
            border-radius: 50%; 
            border: 3px solid #09315D; 
            object-fit: cover; 
            display: block; 
        }

        .modal {
            display: none; 
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            background: rgba(0, 0, 0, 0.8); 
            color: white;
            border-radius: 10px;
            text-align: center;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-content {
            background: #2a2d34;
            padding: 15px;
            border-radius: 10px;
        }

        .modal-content h2 {
            font-size: 14px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .modal-content p {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 8px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal-buttons button:last-child {
            background: #0c2340;
            color: white;
            font-weight: bold;
        }

        .modal-buttons button:first-child {
            background: transparent;
            border: 1px solid #ccc;
            color: #ccc;
        }

        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .no-ideas-message {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #002147;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav id="navbar-fav" class="navbar-fav">
        <div class="profile-header-background">
            <a href="settings1.html">
                <img src="images/settings.png" alt="الإعدادات" class="profile-settings-icon">
            </a>
        </div>
        <div id="humburger-icon" class="humburger-fav" onclick="toggleMenuFav()">
            <span class="bar-fav"></span>
            <span class="bar-fav"></span>
            <span class="bar-fav"></span>
        </div>
    </nav>
    
    <!-- Profile Card -->
    <div class="profile-card">
        <div class="profile">
            <img id="profile-image" src="images/default-profile.png" alt="الصورة الشخصية">
            <h2 id="username">تحميل البيانات...</h2>
        </div>

        <!-- Ideas Section -->
        <div class="profile-ideas-section">
            <h3>أفكاري</h3>
            <div class="profile-ideas-container">
                <div class="loading-spinner" id="ideas-loader"></div>
            </div>
        </div>

        <!-- Contact Info Section -->
        <div class="profile-contact-info">
            <h3>معلومات التواصل</h3>
            <div class="profile-contact-icons">
                <div class="profile-contact-item">
                    <span id="x-handle">تحميل...</span>
                    <img src="images/x..png" alt="X">
                </div>
                <div class="profile-contact-item">
                    <span id="linkedin-handle">تحميل...</span>
                    <img src="images/linkedn.png" alt="LinkedIn">
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div id="delete-confirmation" class="confirmation-popup">
        <p>هل أنت متأكد أنك تريد حذف الفكرة؟</p>
        <div class="confirmation-buttons">
            <button id="confirm-delete">حذف</button>
            <button id="cancel-delete">إلغاء</button>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <div id="menuOverlayFav" class="menu-overlay-fav">
        <a href="Ideas.html">الصفحة الرئيسية</a>
        <a href="profile1.html">الملف الشخصي</a>
        <a href="investRequests.html">طلبات الاستثمار</a>
        <a href="FavouritePage.html">المفضلة</a>
        <a href="#" onclick="openLogoutModal()">تسجيل الخروج</a>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h2>تسجيل الخروج</h2>
            <p>هل أنت متأكد أنك تريد تسجيل الخروج؟</p>
            <div class="modal-buttons">
                <button onclick="closeLogoutModal()">تراجع</button>
                <button onclick="confirmLogout()">تسجيل الخروج</button>
            </div>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification"></div>

    <!-- Scripts -->
    <script>
        // Menu Toggle Function
        function toggleMenuFav() {
            var menu = document.getElementById("menuOverlayFav");
            var humburger = document.getElementById("humburger-icon");

            menu.classList.toggle("active");
            humburger.classList.toggle("active"); // Change the icon to X when opened
        }

        // Logout Modal Functions
        function openLogoutModal() {
            document.getElementById("logoutModal").style.display = "block";
        }
        
        function closeLogoutModal() {
            document.getElementById("logoutModal").style.display = "none";
        }
        
        function confirmLogout() {
            window.location.href = "index.html"; // Redirect to logout at HomePage
        }
    </script>

    <script type="module">
        // Import Firebase components
        import { auth, db } from "./LogIn-Register.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { 
            doc, 
            getDoc, 
            updateDoc, 
            arrayRemove 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Global variables
        let currentUser = null;
        let currentIdeaToDelete = null;

        // Function to show notifications
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
            notification.style.color = 'white';
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Helper function to format date
        function formatDate(timestamp) {
            if (!timestamp) return "تاريخ غير معروف";
            
            // If timestamp is a Firestore timestamp
            if (timestamp && typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleDateString('ar-SA');
            }
            
            // If timestamp is a string date
            if (typeof timestamp === 'string') {
                return timestamp;
            }
            
            // If timestamp is a number (milliseconds)
            if (typeof timestamp === 'number') {
                return new Date(timestamp).toLocaleDateString('ar-SA');
            }
            
            // If timestamp is a Date object
            if (timestamp instanceof Date) {
                return timestamp.toLocaleDateString('ar-SA');
            }
            
            return "تاريخ غير معروف";
        }

        // Function to load user ideas
        function loadUserIdeas(ideas) {
            const ideasContainer = document.querySelector(".profile-ideas-container");
            const ideasLoader = document.getElementById("ideas-loader");
            
            // Hide loader
            ideasLoader.style.display = 'none';
            
            // Clear existing content
            ideasContainer.innerHTML = '';

            // Check if there are any ideas
            if (!ideas || ideas.length === 0) {
                ideasContainer.innerHTML = `<div class="no-ideas-message">لا توجد أفكار بعد. <br>يمكنك إضافة أفكار جديدة من الصفحة الرئيسية.</div>`;
                return;
            }

            // Loop through ideas and create elements
            ideas.forEach((idea, index) => {
                const ideaElement = document.createElement('div');
                ideaElement.className = 'profile-idea-box';
                ideaElement.dataset.ideaId = idea.id || index; // Store idea ID or index for reference
                
                ideaElement.innerHTML = `
                    <div class="profile-idea-icons">
                        <img src="images/delete.png" alt="حذف" class="profile-icon close-icon">
                        <img src="images/update.png" alt="تحديث" class="profile-icon refresh-icon">
                    </div>
                    <img src="${idea.userPhotoURL || idea.photoURL || 'images/default-profile.png'}" alt="صورة المستخدم" class="profile-idea-img">
                    <p class="profile-idea-title">${idea.title}</p>
                    <p class="profile-idea-field">مجال الفكرة: ${idea.category || idea.domain || 'غير محدد'}</p>
                    <p class="profile-idea-date">${formatDate(idea.timestamp || idea.date)}</p>
                `;
                
                ideasContainer.appendChild(ideaElement);
                
                // Add event listeners to the delete icon
                const deleteIcon = ideaElement.querySelector(".close-icon");
                deleteIcon.addEventListener("click", function() {
                    currentIdeaToDelete = {
                        element: ideaElement,
                        id: idea.id || index,
                        idea: idea
                    };
                    document.getElementById("delete-confirmation").style.display = "block";
                });
                
                // Add event listener to the update icon
                const updateIcon = ideaElement.querySelector(".refresh-icon");
                updateIcon.addEventListener("click", function() {
                    // Store the idea to edit in sessionStorage
                    sessionStorage.setItem('ideaToEdit', JSON.stringify(idea));
                    window.location.href = 'updateIdea.html';
                });
            });
        }

        // Function to load user profile data
        async function loadUserProfile(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    console.log("البيانات المسترجعة من Firestore:", userData);

                    // Update username
                    const usernameElement = document.getElementById("username");
                    if (userData.username && userData.username.trim() !== "") {
                        usernameElement.textContent = userData.username;
                    } else {
                        usernameElement.textContent = "مستخدم مجهول";
                    }

                    // Update profile image if available
                    if (userData.profilePicture) {
                        document.getElementById("profile-image").src = userData.profilePicture;
                    } else if (user.photoURL) {
                        document.getElementById("profile-image").src = user.photoURL;
                    }

                    // Update contact info
                    const contactInfo = userData.contactInfo || {};
                    document.getElementById("x-handle").textContent = contactInfo.xHandle || "لم يتم الإضافة";
                    document.getElementById("linkedin-handle").textContent = contactInfo.linkedinHandle || "لم يتم الإضافة";
                    
                    // Load user ideas
                    loadUserIdeas(userData.ideas || []);
                } else {
                    console.error("لم يتم العثور على بيانات المستخدم في Firestore.");
                    document.getElementById("username").textContent = "لم يتم العثور على البيانات.";
                    document.querySelector(".profile-ideas-container").innerHTML = 
                        `<div class="no-ideas-message">لم يتم العثور على بيانات المستخدم.</div>`;
                    document.getElementById("ideas-loader").style.display = 'none';
                }
            } catch (error) {
                console.error("حدث خطأ أثناء جلب البيانات:", error);
                document.getElementById("username").textContent = "خطأ في تحميل البيانات.";
                document.querySelector(".profile-ideas-container").innerHTML = 
                    `<div class="no-ideas-message">حدث خطأ أثناء تحميل الأفكار.</div>`;
                document.getElementById("ideas-loader").style.display = 'none';
            }
        }

        // Main initialization when document is loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Set up authentication state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("المستخدم المسجّل دخوله:", user.uid);
                    currentUser = user;
                    loadUserProfile(user);
                    
                    // Set up delete confirmation handlers
                    const confirmDeleteBtn = document.getElementById("confirm-delete");
                    const cancelDeleteBtn = document.getElementById("cancel-delete");
                    
                    confirmDeleteBtn.onclick = async function() {
                        if (currentIdeaToDelete) {
                            try {
                                // Show loading state
                                confirmDeleteBtn.textContent = "جاري الحذف...";
                                confirmDeleteBtn.disabled = true;
                                
                                // Get user document
                                const userRef = doc(db, "users", user.uid);
                                const userSnap = await getDoc(userRef);
                                
                                if (userSnap.exists()) {
                                    const userData = userSnap.data();
                                    
                                    // Filter out the idea to delete
                                    const updatedIdeas = (userData.ideas || []).filter((idea, idx) => 
                                        (idea.id && idea.id !== currentIdeaToDelete.idea.id) && 
                                        !(idx === currentIdeaToDelete.id && !idea.id)
                                    );
                                    
                                    // Update the user document
                                    await updateDoc(userRef, { ideas: updatedIdeas });
                                    
                                    // Hide confirmation popup
                                    document.getElementById("delete-confirmation").style.display = "none";
                                    
                                    // Remove from UI
                                    currentIdeaToDelete.element.remove();
                                    
                                    // Show success notification
                                    showNotification("تم حذف الفكرة بنجاح");
                                    
                                    // Check if no ideas left
                                    if (updatedIdeas.length === 0) {
                                        document.querySelector(".profile-ideas-container").innerHTML = 
                                            `<div class="no-ideas-message">لا توجد أفكار بعد.</div>`;
                                    }
                                }
                            } catch (error) {
                                console.error("خطأ في حذف الفكرة:", error);
                                showNotification("حدث خطأ أثناء حذف الفكرة", true);
                            } finally {
                                // Reset button state
                                confirmDeleteBtn.textContent = "حذف";
                                confirmDeleteBtn.disabled = false;
                                currentIdeaToDelete = null;
                            }
                        }
                    };
                    
                    cancelDeleteBtn.onclick = function() {
                        document.getElementById("delete-confirmation").style.display = "none";
                        currentIdeaToDelete = null;
                    };
                    
                } else {
                    console.warn("⚠ لا يوجد مستخدم مسجّل دخول، سيتم توجيهه إلى صفحة تسجيل الدخول.");
                    window.location.href = "login.html";
                }
            });
        });
    </script>
</body>
</html>
