<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_back" />
    <title>الملف الشخصي</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
        }

        body {
            background-color: #fff;
            direction: rtl;
        }

        .navbar-fav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: transparent;
            position: relative;
            width: 100%;
        }

        .logo-fav img {
            width: 60px;
            height: auto;
        }

        .profile-card {
            max-width: 450px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .profile img {
            display: block;
            margin: 0 auto;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #002147;
        }

        .profile h2 {
            color: #002147;
            margin-top: 10px;
            text-align: center;
        }

        .profile-ideas-section {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .profile-ideas-section h3 {
            color: #002147;
            margin-bottom: 10px;
            text-align: center;
        }

        .profile-ideas-container {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .profile-idea-box {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            width: 160px;
            position: relative;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .profile-idea-icons {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            flex-direction: row;
            gap: 3px;
        }

        .profile-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .profile-idea-title {
            font-weight: bold;
            font-size: 16px;
            margin-top: 5px;
        }

        .confirmation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #002147;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 250px;
            display: none;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .confirmation-buttons button {
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #confirm-delete {
            background: #1E2532;
            color: white;
        }

        #cancel-delete {
            background: #1E2532;
            color: white;
        }

    </style>
</head>
<body>

    <nav id="navbar-fav" class="navbar-fav">
        <div class="profile-header-background">
            <a href="settings1.html">
                <img src="images/settings.png" alt="الإعدادات" class="profile-settings-icon">
            </a>
        </div> 
        <div id="humburger-icon" class="humburger-fav" onclick="toggleMenuFav()">
            <span class="bar-fav"></span>
            <span class="bar-fav"></span>
            <span class="bar-fav"></span>
        </div>
    </nav>

    <div class="profile-card">
        <div class="profile">
            <img id="profile-img" src="images/default-avatar.png" alt="الصورة الشخصية">
            <h2 id="username">تحميل البيانات...</h2>
        </div>
        <br><br>
        <div class="profile-ideas-section">
            <h3>أفكاري</h3>
            <div class="profile-ideas-container">
                <p style="text-align: center; color: #666;">جارِ تحميل الأفكار...</p>
            </div>
        </div>
        <br><br>
        <div class="profile-contact-info">
            <h3>معلومات التواصل</h3>
            <div class="profile-contact-icons">
                <div class="profile-contact-item">
                    <span id="x-handle">تحميل...</span>
                    <img src="images/x..png" alt="X">
                </div>
                <div class="profile-contact-item">
                    <span id="linkedin-handle">تحميل...</span>
                    <img src="images/linkedn.png" alt="LinkedIn">
                </div>
            </div>
        </div>
    </div>

    <div id="delete-confirmation" class="confirmation-popup">
        <p>هل أنت متأكد انك تريد حذف الفكرة؟</p>
        <div class="confirmation-buttons">
            <button id="confirm-delete">حذف</button>
            <button id="cancel-delete">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./LogIn-Register.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { doc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // دالة لتحميل الأفكار المرتبطة باليوزر
        function loadUserIdeas(userId) {
            const ideasContainer = document.querySelector(".profile-ideas-container");
            ideasContainer.innerHTML = ''; 

            // استعلام لجلب الأفكار التي تخص هذا اليوزر
            const ideasQuery = query(collection(db, "ideas"), where("userId", "==", userId));

            getDocs(ideasQuery)
                .then((snapshot) => {
                    if (snapshot.empty) {
                        ideasContainer.innerHTML = "<p style='text-align: center; color: #666;'>لا توجد أفكار بعد.</p>";
                        return;
                    }

                    snapshot.docs.forEach(docSnap => {
                        const idea = docSnap.data();
                        const ideaElement = `
                            <div class="profile-idea-box" data-id="${docSnap.id}"> 
                                <div class="profile-idea-icons">
                                    <img src="images/delete.png" alt="حذف" class="profile-icon close-icon">
                                    <img src="images/update.png" alt="تحديث" class="profile-icon refresh-icon" onclick="window.location.href='https://fajeralamro.github.io/TestSoft/updateIdea.html?id=${docSnap.id}';">
                                </div>
                                <p class="profile-idea-title">${idea.title}</p>
                                <p class="profile-idea-field">مجال الفكرة: ${idea.domain}</p>
                                <p class="profile-idea-date">${new Date(idea.createdAt.seconds * 1000).toLocaleDateString('ar-SA')}</p>
                            </div>
                        `;
                        ideasContainer.innerHTML += ideaElement;
                    });
                })
                .catch((error) => {
                    console.error("خطأ في جلب الأفكار:", error);
                    ideasContainer.innerHTML = "<p style='text-align: center; color: #666;'>حدث خطأ أثناء تحميل الأفكار.</p>";
                });
        }

        // دالة لحذف الفكرة من Firestore
        function deleteIdea(ideaId) {
            const ideaRef = doc(db, "ideas", ideaId);
            return deleteDoc(ideaRef);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("المستخدم المسجّل دخوله:", user.uid);

                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        console.log("البيانات المسترجعة من Firestore:", userData);

                        document.getElementById("username").textContent = userData.username || "مستخدم مجهول";

                        const profileImg = document.getElementById("profile-img");
                        if (userData.profileImage) {
                            profileImg.src = userData.profileImage;
                        } else {
                            profileImg.src = "images/default-avatar.png"; 
                        }

                        if (userData.contactInfo) {
                            document.getElementById("x-handle").textContent = userData.contactInfo.xHandle || "لم يتم الإضافة";
                            document.getElementById("linkedin-handle").textContent = userData.contactInfo.linkedinHandle || "لم يتم الإضافة";
                        } else {
                            document.getElementById("x-handle").textContent = "لم يتم الإضافة";
                            document.getElementById("linkedin-handle").textContent = "لم يتم الإضافة";
                        }

                        loadUserIdeas(user.uid); 
                    } else {
                        console.error("لم يتم العثور على بيانات المستخدم.");
                        document.getElementById("username").textContent = "لم يتم العثور على البيانات.";
                    }
                } catch (error) {
                    console.error("خطأ أثناء جلب البيانات:", error);
                    document.getElementById("username").textContent = "خطأ في تحميل البيانات.";
                }
            } else {
                console.warn("⚠ لا يوجد مستخدم مسجّل دخول، سيتم توجيهه إلى صفحة تسجيل الدخول.");
                window.location.href = "login.html";
            }
        });

        // وظيفة تأكيد الحذف
        document.addEventListener("DOMContentLoaded", function () {
            const deleteIcons = document.querySelectorAll(".close-icon");
            const deletePopup = document.getElementById("delete-confirmation");
            const confirmDelete = document.getElementById("confirm-delete");
            const cancelDelete = document.getElementById("cancel-delete");
            let currentIdeaBox = null;
            let currentIdeaId = null;

            deleteIcons.forEach(icon => {
                icon.addEventListener("click", function () {
                    currentIdeaBox = this.closest(".profile-idea-box");
                    currentIdeaId = currentIdeaBox.getAttribute('data-id');
                    deletePopup.style.display = "block";
                });
            });

            confirmDelete.addEventListener("click", async function () {
                if (currentIdeaBox && currentIdeaId) {
                    try {
                        await deleteIdea(currentIdeaId); 
                        currentIdeaBox.remove(); 
                        deletePopup.style.display = "none"; 
                    } catch (error) {
                        console.error("خطأ في حذف الفكرة:", error);
                        alert("حدث خطأ أثناء حذف الفكرة.");
                    }
                }
            });

            cancelDelete.addEventListener("click", function () {
                deletePopup.style.display = "none";
            });
        });
    </script>
</body>
</html>
